# BUG-001: Keeper Selection Round Conflict Not Showing Error

**Status:** FIXED
**Reported:** January 2026
**Fixed:** January 25, 2026
**Priority:** Medium
**Type:** Bug

---

## Objective

Fix the silent failure when selecting a player for a round already taken by another keeper, ensuring users see the conflict and can resolve it.

---

## Background

On the Keepers page, when selecting a player for a round that's already taken by another keeper, the selection silently fails. Player doesn't appear in Selected Keepers section and no error message is shown. This created a confusing user experience where actions appeared to do nothing.

---

## Specification

### Problem Description

When a user tried to select a second player at the same round:
1. Click "Select" on a player
2. Player should appear in Selected Keepers table
3. **Actual:** Nothing happens, no error shown
4. **Expected:** Either selection succeeds (allowing temporary conflicts) or clear error message shown

### Root Cause

Database had `@@unique([teamId, seasonYear, keeperRound])` constraint on KeeperSelection. When user tried to select a second player at the same round, Prisma threw P2002 unique constraint error, which was caught by generic error handler and returned as "Internal server error".

The error was being swallowed by the frontend, which only displayed errors for certain status codes, not the generic 500 response.

---

## Technical Approach

### Fix Strategy

Remove the unique constraint and allow temporary conflicts. The UI already had a ConflictAlert component designed to show round conflicts - it just couldn't be triggered because the database prevented the conflict state from existing.

### Schema Change

```prisma
model KeeperSelection {
  // Removed: @@unique([teamId, seasonYear, keeperRound])
  // Kept: @@unique([teamId, playerId, seasonYear])
}
```

### New Workflow

1. Multiple players CAN be selected at the same round (temporary state)
2. ConflictAlert component shows the conflict to user
3. User must bump one player to resolve before finalizing
4. Finalization is blocked if conflicts exist

---

## Files Created

None

---

## Files Modified

| File | Change |
|------|--------|
| `prisma/schema.prisma` | Removed `@@unique([teamId, seasonYear, keeperRound])` constraint |

---

## Acceptance Criteria

- [x] Selecting two players at same round both succeed
- [x] ConflictAlert displays showing the round conflict
- [x] `detectConflicts()` returns conflict at the shared round
- [x] `finalizeSelections()` blocked with "Unresolved conflicts" error
- [x] `bumpPlayer()` still prevents bumping to already-used round
- [x] No silent failures on keeper selection

---

## Verification

### Test Steps

1. Navigate to `/my-team/keepers`
2. Select two FA players (both have Round 15 cost)
3. Both should appear in Selected Keepers table
4. ConflictAlert should display showing Round 15 conflict
5. Try to finalize - should be blocked with error
6. Bump one player to different round
7. Finalize should now succeed

### Commands

```bash
# Apply schema change
npx prisma db push

# Verify constraint removed
npx prisma studio
# Check KeeperSelection model constraints
```

---

## Completion Notes

Fixed January 25, 2026 via `prisma db push`. Verified with test: two FA players selected at Round 15, conflict detected, finalization blocked until resolved.

The fix changed the system behavior from "prevent conflicts at database level" to "allow conflicts temporarily, show in UI, require resolution before finalize". This is a better UX because users can see exactly what the conflict is and decide how to resolve it.

---

## Related

- [TASK-201](../completed/phase-2-keepers/TASK-201.md) - Keeper Selection Interface (where conflict handling was designed)
- [TASK-501g](../completed/phase-5-ui/TASK-501g.md) - Restyle Keepers Page (ConflictAlert component)
