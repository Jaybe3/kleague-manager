# BUG-002: Cannot Set Draft Order or Keepers for Future Season

**Status:** FIXED
**Reported:** January 2026
**Fixed:** January 25, 2026
**Priority:** High
**Type:** Bug
**Fixed By:** TASK-600c, TASK-700 (team-initializer.ts)

---

## Objective

Enable draft order and keeper selection for future seasons before draft data is imported, fixing the chicken-and-egg problem where teams only exist after import.

---

## Background

Draft order page and keeper selection only work for seasons that have teams. But teams are only created when draft data is imported. This creates a chicken-and-egg problem - can't prepare for a draft that hasn't happened yet.

This bug was blocking the entire 2026 draft preparation workflow.

---

## Specification

### Problem Description

**Expected Workflow:**
1. Commissioner creates 2026 season (done - exists with isActive=true)
2. Commissioner sets 2026 draft order BEFORE draft
3. Managers select 2026 keepers BEFORE draft
4. Draft happens with keepers locked at their rounds
5. Draft data imported afterward

**Actual Broken State:**
- 2026 season exists but has no teams
- Draft order dropdown doesn't show 2026
- Keeper selection can't work without teams
- Blocked until draft data imported (which happens AFTER draft)

### Root Cause

The data model assumed Team records would exist before any operations. Team records were only created during draft import, which happens after the draft. This created a circular dependency:
- Keeper selection requires Team records
- Team records created by draft import
- Draft import happens after the draft
- But keepers need to be selected before the draft

---

## Technical Approach

### Solution

Create Team records automatically from slot data when needed, enabling keeper selection and draft preparation for future seasons before draft import.

**Implementation:**
1. Created `lib/slots/team-initializer.ts` with:
   - `initializeTeamsForSeason(year)` - Creates all 10 Team records from slot data
   - `ensureTeamForSlot(slotId, year)` - Ensures a specific team exists

2. Data sources for auto-created teams:
   - `teamName` → from `TeamAlias` (current name where validTo IS NULL)
   - `draftPosition` → from `DraftOrder` table (auto-created if needed)
   - `managerId` → from `TeamSlot.managerId` (current slot owner)

3. Updated keeper API routes to use slot-based lookup and auto-create teams

---

## Files Created

| File | Purpose |
|------|---------|
| `lib/slots/team-initializer.ts` | Team initialization from slot data |

---

## Files Modified

| File | Change |
|------|--------|
| `app/api/my-team/keepers/route.ts` | Uses slot-based lookup, auto-creates teams |

---

## Acceptance Criteria

- [x] Teams auto-created for 2026 season (10 teams)
- [x] Team names sourced from TeamAlias
- [x] Draft positions sourced from DraftOrder
- [x] Manager IDs inherited from TeamSlot
- [x] Draft order page works for 2026
- [x] Keeper selection works for 2026
- [x] Idempotent (second run creates 0 teams)

---

## Verification

### Test Steps

1. Navigate to `/admin/draft-order`
2. Select 2026 from season dropdown
3. Verify 10 teams display with names and positions
4. Navigate to `/my-team/keepers`
5. Verify roster displays for 2026 keeper selection
6. Select a keeper
7. Verify selection saves successfully

### Commands

```bash
# Verify 2026 teams exist
npx tsx -e "import { db } from './lib/db'; db.team.count({ where: { seasonYear: 2026 } }).then(console.log)"
# Expected: 10
```

---

## Completion Notes

Fixed January 25, 2026. Created team-initializer.ts, updated keepers API route.

**Test Results:**
- 10 teams created for 2026 with correct names and draft positions
- Idempotency verified (second run reports 10 teams already existed, creates 0)
- Draft order and keeper selection now work for future seasons

**Cascade Bug (discovered during fix):**
Original implementation had a bug where the keepers route used "most recent team" logic combined with `ensureTeamForSlot()`, causing infinite team creation (2027, 2028, ... up to 2032+). Fixed by anchoring to active season instead. This pattern is now documented in `.clinerules` as the "Keeper Route Pattern" to prevent future cascade bugs.

**Note:** This bug was discovered during TASK-501j (Admin Draft Order Page restyle) and was addressed as part of the Phase 6 refactor (TASK-600a, 600b, 600c, TASK-700).

---

## Related

- [TASK-700](../completed/phase-6-refactor/TASK-700.md) - Initialize Teams for Future Seasons (the fix)
- [TASK-600c](../completed/phase-6-refactor/TASK-600c.md) - Code Migration (part of fix)
- [TASK-501j](../completed/phase-5-ui/TASK-501j.md) - Admin Draft Order Page (where bug was discovered)
- [TASK-104](../completed/phase-1-import/TASK-104.md) - Team Identity System (Slots)
