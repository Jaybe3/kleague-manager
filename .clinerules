# .clinerules - KLeague Manager Development Rules

## CRITICAL: Verified Development Framework

This project follows the Verified Development Framework. Every action must be transparent and independently verifiable by the user.

### MANDATORY WORKFLOW (NEVER SKIP):
1. READ PRD.md, tasks/INDEX.md, docs/DEVELOPMENT.md before ANY coding
2. CREATE detailed specification for current task
3. WAIT for explicit user approval on specification
4. IMPLEMENT incrementally (one small piece at a time)
5. PROVIDE exact verification commands the user can run
6. SHOW expected vs actual output
7. WAIT for user to verify independently
8. ONLY proceed after explicit user approval

### ABSOLUTE RULES:
- NEVER write code without approved specification
- NEVER claim something works without verification commands
- NEVER use mock/fake/simulated data
- NEVER skip user approval step
- ALWAYS provide commands user can run themselves
- ALWAYS show database state via Prisma Studio or queries
- DEFAULT to asking clarifying questions rather than assuming

### DOCUMENTATION REQUIREMENTS (MANDATORY):
After ANY task completion or significant code changes, update:
1. Relevant docs in `docs/` folder (ARCHITECTURE.md, API.md, DATABASE.md, etc.)
2. Task file in `tasks/` folder (move to completed, update all sections)
3. `tasks/INDEX.md` - Update status and summary
4. `.clinerules` - If any rules, patterns, or critical learnings changed

A task is NOT complete until documentation is updated.
Never close a task without verifying these files reflect current reality.

---

## Team Identity System (CRITICAL - Added 2026-01-18)

**Problem:** CBS Sports retroactively renames historical data when teams rebrand.

**Solution:** Slots (permanent league positions 1-10)
- `TeamSlot` table: 10 permanent records, never changes
- `TeamAlias` table: Maps team names → slots with year ranges
- Keeper logic follows SLOT, not team name

**Lookup:** `getSlotIdFromTeamName(name, year)` handles all variations.

**Example:**
- "Discount Belichick" (2023-2024) = Slot 5
- "Seal Team Nix" (2025, CBS applied retroactively) = Slot 5

---

## Keeper Route Pattern (CRITICAL - Added 2026-01-25)

**All keeper API routes MUST use this pattern to avoid cascade bugs:**
```typescript
// 1. Get user's slot (permanent league position)
const slot = await getSlotForManager(session.user.id);

// 2. Get active season (anchors to a fixed year)
const activeSeason = await db.season.findFirst({ where: { isActive: true } });

// 3. Derive years from active season (NOT from "most recent team")
const targetYear = activeSeason.year;  // Selecting keepers FOR this year
const rosterYear = targetYear - 1;      // Roster we're selecting FROM

// 4. Get roster team for the roster year
const rosterTeam = await db.team.findFirst({
  where: { slotId: slot.id, seasonYear: rosterYear },
});

// 5. Use rosterTeam.id for all keeper operations
```

**Why:** Using "most recent team" + `ensureTeamForSlot()` caused cascade bug (created teams for 2027, 2028...).

**Files using this pattern:**
- `app/api/my-team/keepers/route.ts`
- `app/api/my-team/keepers/bump/route.ts`
- `app/api/my-team/keepers/[playerId]/route.ts`
- `app/api/my-team/keepers/finalize/route.ts`

---

## Season Configuration

**Total Rounds:**
- 2023, 2024: `totalRounds = 27`
- 2025+: `totalRounds = 28`

---

## Keeper Cost Calculation (CRITICAL - CORRECTED 2026-01-16)

**The Rules:**
1. Year 2 (1st keeper year): Keep at original cost (draft round or R15 for FA)
2. Year 3+ (2nd+ keeper year): Keep at (previous year - 4)
3. Ineligibility: If cost < 1, player is INELIGIBLE

**Examples:**
- Round 6: Y2=R6, Y3=R2, Y4=INELIGIBLE
- Round 10: Y2=R10, Y3=R6, Y4=R2, Y5=INELIGIBLE
- Free Agent: Y2=R15, Y3=R11, Y4=R7, Y5=R3, Y6=INELIGIBLE

**Keeper Base Acquisition Rule (FINAL - 2026-01-20):**

CBS Behavior: When you KEEP a player, CBS creates a NEW "DRAFT" record each year.
So kept players have MULTIPLE DRAFT records on the same slot across seasons.

Algorithm:
1. Find ALL acquisitions for player on this SLOT (any season)
2. If multiple exist → Return EARLIEST (keeper clock started there)
3. If only one (fresh):
   - DRAFT → Use this draft (fresh start)
   - TRADE → Find earliest DRAFT across ALL teams
   - FA same season as a DRAFT → Inherit that draft round
   - FA never drafted that season → True FA, use Round 15

---

## Database: PlayerAcquisition.droppedDate

- `null` = player still on roster
- `DateTime` = player was dropped
- Roster queries filter `droppedDate: null`

---

## Documentation Standards (Added 2026-02-01)

### Project File Structure
kleague-manager/
├── .clinerules              # Development rules (THIS FILE)
├── PRD.md                   # Product requirements
├── ADMIN-GUIDE.md           # Operational guide
├── docs/
│   ├── README.md            # Project overview (investor/stakeholder facing)
│   ├── ARCHITECTURE.md      # System design, diagrams, decisions
│   ├── DATABASE.md          # Schema, ERD, relationships
│   ├── API.md               # Full endpoint reference
│   ├── DEVELOPMENT.md       # Developer setup & workflow
│   ├── TESTING.md           # Test strategy & coverage
│   ├── DEPLOYMENT.md        # Environments & deploy process
│   ├── SECURITY.md          # Auth, access control
│   ├── CHANGELOG.md         # Release history
│   ├── ROADMAP.md           # Future plans
│   └── PROCESS.md           # Development process explanation
├── tasks/
│   ├── INDEX.md             # Master task dashboard (ALWAYS update)
│   ├── active/              # Currently in-progress tasks
│   ├── backlog/             # Prioritized future work
│   ├── completed/           # Done tasks (organized by phase)
│   │   ├── phase-0-setup/
│   │   ├── phase-1-import/
│   │   ├── phase-2-keepers/
│   │   ├── phase-3-draft-board/
│   │   ├── phase-4-admin/
│   │   ├── phase-5-ui/
│   │   └── phase-6-refactor/
│   ├── bugs/                # Bug tracking
│   └── templates/
│       └── TASK-TEMPLATE.md # Standard format for all tasks
└── [source code...]

### Task Lifecycle (MANDATORY)

1. **CREATE** - New task created from `tasks/templates/TASK-TEMPLATE.md`
2. **SPECIFY** - Full specification written in task file, user approves
3. **IMPLEMENT** - Code written incrementally with verification at each step
4. **DOCUMENT** - All sections of task file completed (no empty sections)
5. **VERIFY** - User confirms working via provided verification commands
6. **CLOSE** - Task file moved to `tasks/completed/{phase}/`, INDEX.md updated

### Definition of Done (A task is NOT complete until ALL checked):

- [ ] All acceptance criteria in task file checked off
- [ ] "Files Created" table populated (if applicable)
- [ ] "Files Modified" table populated (if applicable)
- [ ] Verification commands provided AND executed successfully
- [ ] "Completion Notes" section written with actual outcome
- [ ] Task file moved to `tasks/completed/{phase}/`
- [ ] `tasks/INDEX.md` updated with completion status
- [ ] Related docs updated if applicable (ARCHITECTURE.md, API.md, DATABASE.md)
- [ ] User has explicitly approved closure

### When Starting ANY Session

1. Read `.clinerules` (this file)
2. Read `tasks/INDEX.md` for current project status
3. Read any active task file in `tasks/active/`
4. Confirm with user which task to work on before ANY coding
5. If new task needed, create from template first

### Task File Requirements

Every task file MUST contain these sections (use template):
- Status, Dates, Priority, Dependencies, Phase
- Objective (1-2 sentences)
- Background (why this task exists)
- Specification (detailed requirements)
- Technical Approach (how it will be implemented)
- Files Created/Modified (tables)
- Acceptance Criteria (checkboxes)
- Verification (commands/steps)
- Completion Notes (what actually happened)
- Related (links to other tasks/docs)

Empty sections are NOT acceptable. Write "N/A - [reason]" if truly not applicable.

---

**Last Updated:** February 1, 2026
